<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Aire de jeux</title>
    <style>
        #playground{
            border: 1px solid black;
            height: 600px;
            width: 800px;
            background: url("desert_sand.jpg");
        }
        #playground * {
          position: absolute;
        }
    </style>
</head>
<body>
    <div id="playground">

    </div>

    <script>
        // Notion de Position : s'utilise avec ou sans le new
        function Position(x=0,y=0) {
            if (this == undefined || this == window) {
                // on crée un nouvel objet par new que l'on rend
                return new Position(x,y);
            }
            this.x = x;
            this.y = y;
        }

        // Fonction ajoute une position à this
        Position.prototype.add = function(pos=Position()) {
            this.x += pos.x;
            this.y += pos.y;
        }

        let p1 = Position(-3,7);
        let p2 = new Position(5,3);
        p1.add(p2);
        // p1 doit être (2,10)

        //Définition de la calsse Sprite
        function Sprite(imgPath="R2D2.png",insideDOM=window.document.getElementById("playground")) {
            this.pos = Position(0,0);
            let img = document.createElement("img");
            img.setAttribute("src", imgPath);
            this.DOM = insideDOM.appendChild(img);
            this.speedX = 0;
            this.speedY = 0;
        };

        Sprite.prototype.moveTo = function(pos=Position(),whenOutOfPlayground = function(pos) {
          console.error("move from (%d,%d) to (%d,%d) is to out of playground ",this.pos.x,this.pos.y,pos.x,pos.y);
        }) {
            this.DOM.style.left = pos.x+"px";
            this.DOM.style.top = pos.y+"px";
            if (pos.x > 800 - this.DOM.clientWidth || pos.y > 600 - this.DOM.clientHeight) {
              whenOutOfPlayground.call(this, pos);
            }

            if (pos.x < 0 || pos.y < 0) {
              whenOutOfPlayground.call(this, pos);
            }
        };

        /*Sprite.prototype.moveTo = function(pos=Position(),
      whenOutOfPlayground = function(pos) {
        console.error("move from (%d,%d) to (%d,%d) is to out of playground ",this.pos.x,this.pos.y,pos.x,pos.y);
      }
      )*/

        Sprite.prototype.moveRel = function(pos=Position()) {
            this.pos.add(Position(pos.x, pos.y));
            this.moveTo(this.pos);
        };

        Sprite.prototype.moveFrame = function(duration) {
            let x = this.speedX * duration / 1000;
            let y = this.speedY * duration / 1000;
            this.moveRel(Position(x,y));
        }

        Sprite.prototype.getHitbox = function(pos) {
          if('undefined' !== pos) {
            let size = this.DOM.width;
            let position = new Position(pos.x, pos.y);
            return new Rectangle(position, size);
          }
        }

        // Définition de la classe Robot
        function Robot(imgPath="R2D2.png",insideDOM=window.document.getElementById("playground")) {
            Sprite.call(imgPath, insideDOM);
        }

        Robot.prototype = new Sprite();
        Robot.constructor = Sprite;

        let game = {
          arrowLeft : false,
          arrowRight : false,
          arrowUp : false,
          arrowDown : false,
          robot : new Robot(),
          run : true,
          tFrameLast : 0,
        }

        game.update = function (tFrame) {
          let time = tFrame - game.tFrameLast;
          game.tFrameLast = tFrame;
          speed = 100;

          if (this.arrowLeft) {
            game.robot.getHitbox(game.robot.pos);
            this.robot.speedX = -speed;
          } else if (this.arrowRight) {
            this.robot.speedX = speed;
          } else {
            this.robot.speedX = 0;
          }

          if (this.arrowUp) {
            this.robot.speedY = -speed;
          } else if (this.arrowDown) {
            this.robot.speedY = speed;
          } else {
            this.robot.speedY = 0;
          }
          
          game.robot.moveFrame(time);
        }

        window.onkeydown = function (e) {
          if ('ArrowUp' === e.key) {
            game.arrowUp = true;
          }

          if ('ArrowLeft' === e.key) {
            game.arrowLeft = true;
          }

          if ('ArrowDown' === e.key) {
            game.arrowDown = true;
          }

          if ('ArrowRight' === e.key) {
            game.arrowRight = true;
          }

          if ('s' === e.key) {
            game.run = false;
          }
        }

        window.onkeyup = function (e) {
          if ('ArrowUp' === e.key) {
            game.arrowUp = false;
          }

          if ('ArrowLeft' === e.key) {
            game.arrowLeft = false;
          }

          if ('ArrowDown' === e.key) {
            game.arrowDown = false;
          }

          if ('ArrowRight' === e.key) {
            game.arrowRight = false;
          }
        }

        function Rectangle(pos=Position(),size=Size2D()) {
          this.pos = pos;
          this.size = size;
        }

        Rectangle.areIntersecting = function(r1,r2) {
          if(r2.pos.x === r1.pos.x + r1.size.width) {
            return true;
          }

          if(r2.pos.x + r2.size.width === r1.pos.x ) {
            return true;
          }
        }

        Rectangle.prototype.inside = function (r=Rectangle()) {
          if((this.pos.x < r.pos.x + r.size.width) && (this.pos.x > r.pos.x)) {
            return true;
          }

          if((this.pos.x + this.size.width > r.pos.x) && (this.pos.x + this.size.width < r.pos.x + r.size.width)) {
            return true;
          }
        }

        function Size2D(width=0,height=0) {
          this.width = width;
          this.height = height;
        }




        // tFrame est le temps d'appel de l'animation passé à main en ms       
        function main(tFrame) {

          game.stopMain = window.requestAnimationFrame( main );
          if (! game.run) {
            window.cancelAnimationFrame( game.stopMain );
            console.log("Game over");
          } else {
            game.update(tFrame);
          }
        }
  
        main(0);
        
    </script>
</body>
</html>
